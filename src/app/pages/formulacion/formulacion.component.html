<!-- SELECCIÓN MENÚ PRINCIPAL -->
<mat-card class="card-oas">
  <mat-card-header>
    <mat-card-title>Formulación de Planes</mat-card-title>
  </mat-card-header>
  <mat-card-content>
    <ng-container>
      <mat-form-field appearance="fill" [style.width.%]="100">
        <mat-label id="tipo-input-label">Seleccione la Unidad</mat-label>
          <mat-select (selectionChange)="onChangeU($event.value)">
            <mat-option>--</mat-option>
            <mat-option *ngFor="let unidad of unidades" [value]="unidad">
              {{unidad.Nombre}}
            </mat-option>
          </mat-select>
      </mat-form-field>
    </ng-container>
    <ng-container *ngIf="unidadSelected">
      <mat-form-field appearance="fill" [style.width.%]="100">
        <mat-label id="tipo-input-label">Seleccione la Vigencia</mat-label>
          <mat-select (selectionChange)="onChangeV($event.value)">
            <mat-option>--</mat-option>
            <mat-option *ngFor="let vigencia of vigencias" [value]="vigencia">
              {{vigencia.Nombre}}
            </mat-option>
          </mat-select>
      </mat-form-field>
    </ng-container>
    <ng-container *ngIf="vigenciaSelected">
      <mat-form-field appearance="fill" [style.width.%]="100">
        <mat-label id="tipo-input-label">Seleccione el Plan</mat-label>
          <mat-select (selectionChange)="onChangeP($event.value)">
            <mat-option>--</mat-option>
            <mat-option *ngFor="let plan of planes" [value]="plan">
              {{plan.nombre}}
            </mat-option>
          </mat-select>
      </mat-form-field>
    </ng-container>
  </mat-card-content>
  <mat-card-footer *ngIf="clonar" style="text-align: center;">
    <ng-container>
      <button mat-raised-button color="primary" (click)="formularPlan()">
        Formular plan
      </button>
    </ng-container>
    <br><br>
  </mat-card-footer>
</mat-card>

<br><br>
<!-- FORMULACIÓN -->
<mat-card class="card-oas" *ngIf="!clonar && planAsignado">
  <mat-card-header>
    <mat-card-title *ngIf="plan != undefined">Formulación {{plan.nombre}}</mat-card-title>
  </mat-card-header>
  <mat-card-content>
    <!-- TABLA ESTÁTICA -->
    <ng-container *ngIf="(plan.tipo_plan_id == '61639b8c1634adf976ed4b4c' || plan.tipo_plan_id == '61639c701634adbf74ed4b50') && dataT">
      <mat-form-field appearance="standard" [style.width.%]="50">
        <mat-label>Búsqueda</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Ej. Actividad" #input>
      </mat-form-field>
        <table mat-table [dataSource]="dataSource" class="mat-elevation-z8" matSort>
          <ng-container matColumnDef="index">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Número </th>
            <td mat-cell *matCellDef="let element"> {{element.index}} </td>
          </ng-container>
          <ng-container [matColumnDef]="column" *ngFor="let column of displayedColumns">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> {{column}} </th>
            <td mat-cell *matCellDef="let element"> {{element[column]}} </td>
          </ng-container>
          <ng-container matColumnDef="activo">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
            <td mat-cell *matCellDef="let element"> {{element.activo}} </td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="header-align-right"> Acciones </th>
            <td mat-cell *matCellDef="let row" class="td-align-right">
                <button mat-icon-button (click)="editar(row)"><mat-icon>edit</mat-icon></button>
                <button mat-icon-button (click)="inhabilitar(row)"><mat-icon>delete_outline</mat-icon></button>
           </td>
          </ng-container>
          <!-- <tr mat-header-row *matHeaderRowDef="columnsToDisplay.concat(['activo','index','actions'])"></tr>
          <tr mat-row *matRowDef="let row; columns: columnsToDisplay.concat(['activo','index','actions']);"></tr> -->
          <tr mat-header-row *matHeaderRowDef="['index'].concat(columnsToDisplay.concat(['activo','actions']))"></tr>
          <tr mat-row *matRowDef="let row; columns: ['index'].concat(columnsToDisplay.concat(['activo','actions']));"></tr>
          
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" colspan="4">No se han encontrado resultados para la búsqueda "{{input.value}}"</td>
          </tr>
        </table>
        <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" aria-label="Select page of users"></mat-paginator>
    </ng-container>

    <div *ngIf="!dataT" style="text-align: center;">
      No hay actividades registradas. Por favor Agregue una Actividad.
    </div>

    <br><br>
    <!-- ARMONIZACIÓN -->
    <mat-card class="card-oas-int" *ngIf="!clonar && planAsignado && addActividad">
      <mat-card-header>
        <mat-card-title *ngIf="plan != undefined">Armonización  {{plan.nombre}}</mat-card-title>
      </mat-card-header>
      <mad-card-content>
        <ng-container>
          <mat-form-field appearance="fill" [style.width.%]="100">
            <mat-label id="tipo-input-label">Seleccione el plan de desarrollo</mat-label>
              <mat-select (selectionChange)="onChangePD($event.value)">
                <mat-option>--</mat-option>
                <mat-option *ngFor="let planD of planesDesarrollo" [value]="planD">
                  {{planD.nombre}}
                </mat-option>
              </mat-select>
          </mat-form-field>
        </ng-container>
        <app-arbol *ngIf="tipoPlanId !== undefined && tipoPlanId != ''" [tipoPlanId]="tipoPlanId" [idPlan]="idPadre" [dataArmonizacion]="dataArmonizacion" [consulta]="false" [armonizacion]="true" (grupo)="receiveMessage($event)" [updateSignal]="eventChange"></app-arbol>
      </mad-card-content>
    </mat-card>

    <br><br> 
    <mat-card class="card-oas-int" *ngIf="addActividad">
    <!-- FORMULARIO -->
    <mat-card-content>
    <form [formGroup]="form">
      <mat-vertical-stepper>
        <mat-step *ngFor="let step of steps; let index = index; let last = last;">
          <ng-template matStepLabel>{{step.nombre}}</ng-template>
          <!-- PRIMER NIVEL -->
          <mat-form-field appearance="outline" [style.width.%]="100" *ngIf="step.type == 'input'">
            <mat-label>Digite la información:</mat-label>
            <textarea matInput formControlName="{{step.id}}" placeholder="Escriba la información deseada" required="{{step.required}}"></textarea>
            <mat-icon matSuffix>create</mat-icon>
          </mat-form-field>
          <mat-form-field appearance="outline" [style.width.%]="100" *ngIf="step.type == 'numeric'">
            <mat-label>Ingrese el valor:</mat-label>
            <input type="number" matInput formControlName="{{step.id}}" placeholder="Ingrese el valor numérico" required="{{step.required}}">
            <mat-icon matSuffix>create</mat-icon>
          </mat-form-field>
          <mat-form-field appearance="fill" [style.width.%]="100" *ngIf="step.type == 'select'">
              <mat-select (selectionChange)="onChangeSelect($event.value)" formControlName="{{step.id}}" required="{{step.required}}">
                <mat-option>--</mat-option>
                <mat-option *ngFor="let opt of step.options" [value]="opt.valor">
                  {{opt.valor}}
                </mat-option>
              </mat-select>
          </mat-form-field>
          <button mat-raised-button color="primary" type="submit" class="col-3 mt-2 mb-3" *ngIf="step.type == 'button'" (click)="but()">Foo</button>
          <!-- OBSERVACIÓN -->
          <ng-container *ngIf="estado != '614d3ad301c7a200482fabfd'">
            <mat-form-field appearance="outline" [style.width.%]="100" *ngIf="step.required == 'true'">
              <mat-label>Campo de observación:</mat-label>
              <textarea matInput formControlName="{{step.id+'_o'}}" placeholder="Escriba la observación" required="false"></textarea>
              <mat-icon matSuffix>create</mat-icon>
            </mat-form-field>
          </ng-container>
          <!-- SEGUNDO NIVEL -->
          <mat-accordion cdkDropList>
            <mat-expansion-panel *ngFor="let subs of step.sub" cdkDrag
            (opened)="panelOpenState = true"
            (closed)="panelOpenState = false">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  {{subs.nombre}}
                </mat-panel-title>
                <mat-panel-description>
                </mat-panel-description>
              </mat-expansion-panel-header>
              <!-- TERCER NIVEL -->
              <ng-container *ngIf="subs.sub">
                <mat-accordion>
                  <mat-expansion-panel *ngFor="let subpanel of subs.sub"
                    (opened)="panelOpenState = true"
                    (closed)="panelOpenState = false">
                    <mat-expansion-panel-header>
                      <mat-panel-title>{{subpanel.nombre}}</mat-panel-title>
                      <mat-panel-description>
                      </mat-panel-description>
                    </mat-expansion-panel-header>
                    <mat-form-field appearance="outline" [style.width.%]="100" *ngIf="subpanel.type == 'input'">
                      <mat-label>Digite la información:</mat-label>
                      <textarea matInput formControlName="{{subpanel.id}}" placeholder="Escriba la información deseada" required="{{subpanel.required}}"></textarea>
                      <mat-icon matSuffix>create</mat-icon>
                    </mat-form-field>
                    <mat-form-field appearance="outline" [style.width.%]="100" *ngIf="subpanel.type == 'numeric'">
                      <mat-label>Ingrese el valor:</mat-label>
                      <input type="number" matInput formControlName="{{subpanel.id}}" placeholder="Ingrese el valor numérico" required="{{subpanel.required}}">
                      <mat-icon matSuffix>create</mat-icon>
                    </mat-form-field>
                    <mat-form-field appearance="fill" [style.width.%]="100" *ngIf="subpanel.type == 'select'">
                        <mat-select (selectionChange)="onChangeSelect($event.value)" formControlName="{{subpanel.id}}" required="{{subpanel.required}}">
                          <mat-option>--</mat-option>
                          <mat-option *ngFor="let opt of subpanel.options" [value]="opt.valor">
                            {{opt.valor}}
                          </mat-option>
                        </mat-select>
                    </mat-form-field>
                    <button mat-raised-button color="primary" type="submit" class="col-3 mt-2 mb-3" *ngIf="subpanel.type == 'button'" (click)="but()">Foo</button>
                    <!-- OBSERVACIÓN -->
                    <ng-container *ngIf="estado != '614d3ad301c7a200482fabfd'">
                      <mat-form-field appearance="outline" [style.width.%]="100" *ngIf="subpanel.required == 'true'">
                        <mat-label>Campo de observación:</mat-label>
                        <textarea matInput formControlName="{{subpanel.id+'_o'}}" placeholder="Escriba la observación" required="false"></textarea>
                        <mat-icon matSuffix>create</mat-icon>
                      </mat-form-field>
                    </ng-container>
                  </mat-expansion-panel>
                </mat-accordion>
              </ng-container>
              <mat-form-field appearance="outline" [style.width.%]="100" *ngIf="subs.type == 'input'">
                <mat-label>Digite la información:</mat-label>
                <textarea matInput formControlName="{{subs.id}}" placeholder="Escriba la información deseada" required="{{subs.required}}"></textarea>
                <mat-icon matSuffix>create</mat-icon>
              </mat-form-field>
              <mat-form-field appearance="outline" [style.width.%]="100" *ngIf="subs.type == 'numeric'">
                <mat-label>Ingrese el valor:</mat-label>
                <input type="number" matInput formControlName="{{subs.id}}" placeholder="Ingrese el valor numérico" required="{{subs.required}}">
                <mat-icon matSuffix>create</mat-icon>
              </mat-form-field>
              <mat-form-field appearance="fill" [style.width.%]="100" *ngIf="subs.type == 'select'">
                  <mat-select (selectionChange)="onChangeSelect($event.value)" formControlName="{{subs.id}}" required="{{subs.required}}">
                    <mat-option>--</mat-option>
                    <mat-option *ngFor="let opt of subs.options" [value]="opt.valor">
                      {{opt.valor}}
                    </mat-option>
                  </mat-select>
              </mat-form-field>
              <button mat-raised-button color="primary" type="submit" class="col-3 mt-2 mb-3" *ngIf="subs.type == 'button'" (click)="but()">Foo</button>
              <!-- OBSERVACIÓN -->
              <ng-container *ngIf="estado != '614d3ad301c7a200482fabfd'">
                <mat-form-field appearance="outline" [style.width.%]="100" *ngIf="subs.required == 'true'">
                  <mat-label>Campo de observación:</mat-label>
                  <textarea matInput formControlName="{{subs.id+'_o'}}" placeholder="Escriba la observación" required="false"></textarea>
                  <mat-icon matSuffix>create</mat-icon>
                </mat-form-field>
              </ng-container>
            </mat-expansion-panel>
          </mat-accordion>
          <br><br>
          <div>
            <button mat-raised-button color="primary" type="submit" class="col-3 mt-2 mb-3" *ngIf="index !== 0" matStepperPrevious (click)="prevStep(index)">Volver</button>
            <button mat-raised-button color="primary" type="submit" class="col-3 mt-2 mb-3" *ngIf="!last" matStepperNext (click)="nextStep(index)">Siguiente</button>
            <br><br>
            <button mat-raised-button color="primary" type="submit" class="col-3 mt-2 mb-3" (click)="ocultar()">Cancelar</button>
            <button mat-raised-button color="primary" type="submit" class="col-3 mt-2 mb-3" *ngIf="last" [disabled]="!form.valid" (click)="submit()">Guardar</button>
            <!-- <button *ngIf="index !== 0" matStepperPrevious class="btn btn-primary" type="button" (click)="prevStep(index)">Atrás</button>
            <button *ngIf="!last" matStepperNext class="btn btn-primary" type="button" [disabled]="!formStep.at(index).valid" (click)="nextStep(index)">Siguiente</button>
            <button *ngIf="last" class="btn btn-primary" [disabled]="!formStep.valid" type="submit">Guardar</button> -->
          </div> 
        </mat-step>
      </mat-vertical-stepper>
    </form>
  </mat-card-content>
  </mat-card>
  </mat-card-content>
  <!-- AGREGAR ACTIVIDAD / IDENTIFICACIÓN / CULMINAR PLAN -->
  <mat-card-footer style="text-align: center;">
    <ng-container>
      <button mat-raised-button color="primary" (click)="agregarActividad()" [disabled]="addActividad">
        Agregar actividad
      </button>
      <br><br>
      <button mat-raised-button color="primary" (click)="identificarContratistas()" [disabled]="!dataT">
        Identificación de Contratistas
      </button>
      <br><br>
      <button mat-raised-button color="primary" (click)="identificarRecursos()" [disabled]="!dataT">
        Identificación de Recursos
      </button>
      <br><br>
      <button mat-raised-button color="primary" (click)="identificarDocentes()" [disabled]="!dataT">
        Identificación de Recurso Docente 
      </button>
      <br><br>
      <button mat-raised-button color="primary" (click)="culminarPlan()" [disabled]="!dataT">
        Culminar plan
      </button>
    </ng-container>
    <br><br>
  </mat-card-footer>
</mat-card>

<!-- DIRECTIVAS IDENTIFICACIÓN RECURSOS Y CONTRATISTAS -->
<br><br>
<ng-container class="card-oas" *ngIf="!clonar && planAsignado && identContratistas">
  <app-contratistas [dataSourceActividades]="dataSource" [dataTabla]="identContratistas" [plan]="plan._id" (acciones)="messageIdentificacion($event)">
  </app-contratistas>
</ng-container>
<br><br>
<ng-container class="card-oas" *ngIf="!clonar && planAsignado && identRecursos">
  <app-recursos [dataSourceActividades]="dataSource" [dataTabla]="identRecursos" [plan]="plan._id" (acciones)="messageIdentificacion($event)">
  </app-recursos>
</ng-container>
<ng-container class="card-oas" *ngIf="!clonar && planAsignado && identDocentes">
  <app-docentes [dataSourceActividades]="dataSource" [dataTabla]="identDocentess" [plan]="plan._id" (acciones)="messageIdentificacion($event)">
  </app-docentes>
</ng-container>